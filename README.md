# antimaks
Проект для пересылки сообщений из некого мессенджера с вебсокет подключением в телеграм
### Установка бота
Для начала необходимо установить на сервер подходящий дистрибутив linux с systemd, настоятельно рекомендуется ubuntu-server 24 lts (даллее инструкции для данного дистрибутива).

Скачиваем git (если не установлен):

```sudo apt-get install git```

Далее необходимо скопировать проект в папку пользователя.

```git clone https://github.com/califvladlen/antimaks.git```

теперь необходимо создать виртуальное окружение
```
cd antimaks
sudo apt install -y python3-venv
python3 -m venv myenv
source myenv/bin/activate
```

теперь необходимо установить библиотеки для работы бота.
```pip install -r requirements.txt```

### Настройка бота
для начала необходимо запустить бота в первый раз 
```python3 first_run.py```
после будут созданы файлы для настройки.
Приступим к их заполнению.
##### (Внимание! все инструкции ниже показаны для браузера google-chrome)
Откройте интересующую вас страницу в браузере, авторизируйтесь зайдите в любой чат. нажмите f12 и перезагрузите страницу. Теперь в появившемся окне откройте вкладку network. в данной вкладке в колонке name найдите строку websocket и откройте её. Во вкладке Headers скопируйте значение слева от Request URL. Откройте на сервере с ботом файл bot_settings.json в параметре "requests_domen": "тут" пропишите полученное значение.
В этом же файле пропишите токен для телеграм бота в параметре "token": "тут" (как его получить можете узнать погуглив).
Всё в том же файле необходимо прописать параметр "from_chat_id": "тут", его обычно можно получить зайдя в веб браузере в нужный чат и скопировав его id из строки с адресом сайта (обычно выглядит так: https://что-то.ru/нужное значение).

Теперь необходимо прописать 2 начальных сообщения. Для этого снова откройте интересующую вас страницу в браузере, авторизируйтесь зайдите в любой чат. нажмите f12 и перезагрузите страницу. Теперь в появившемся окне откройте вкладку network. в данной вкладке в колонке name найдите строку websocket и откройте её. В открывшейся вкладке откройте вкладку Messages, пролистайте в самы верх. Первую строчку необзодимо скопировать в файл first.json, второе в файл second.json (удобнее всего скопировать нажав ПКМ по нужной строке и выбрать пункт Copy message). 

Запускаем бота второй раз:
```python3 first_run.py```
Заходим в телеграм, добавляем нашего бота в нужный чат, пишем /start. если бот ответил, значит всë ок. нажимаем Ctrl+z чтобы выключить бота. 
теперь перезапускаем сервер командой ```sudo reboot``` , прописываем пароль и сервер перезагружается. 

### Настройка systemd для авто перезапуска бота. 

Теперь бот может работать, но т.к. это запросы к вебсокету могут быть нестабильны, да и сам бот несовершенен, необходимо сделать для него автоперезапуск в случае падения.

для начала прописываем в терминале команды:
```cd antimaks```
```pwd``` 
вывод команды необходимо сохранить (далее он понадобится)
```sudo nano /etc/systemd/system/antimaksbot.service```
вводим пароль администратора, и в открывшемся, файле пишем:
```
[Unit]
Description=My test service
After=multi-user.target

[Service]
User=имяпользователя
Group=имяпользователя
Type=simple
WorkingDirectory=вывод команды pwd
Restart=always
RestartSec=10s
ExecStart=результат_вывода_команды_pwd/myenv/bin/python3 результат_вывода_команды_pwd/main.py
Environment=PYTHONUNBUFFERED=1
[Install]
WantedBy=multi-user.target
```

после редактирования файла необходимо нажать ctrl+x, потом нажать y, после enter.

теперь необходимо выполнить следующие команды :

```
sudo systemctl daemon-reload
sudo systemctl enable antimaksbot.service
sudo systemctl start antimaksbot.service

```

если после ввода команд просит ввести пароль, вводим. 

теперь бот запущен и добавлен в автозагрузку, проверить это можно всë этой же командой /start в телеграмм чате с ботом. 

если же бот не запустился на данном этапе, проверить его состояние можно командой 
```
sudo systemctl status antimaksbot.service
```
в случае неудачи будут выведены коды ошибок. 

##### По вопросам о проекте писать на почту: kaliforniyec@outlook.com
